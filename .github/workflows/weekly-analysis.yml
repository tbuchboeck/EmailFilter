name: Weekly Email Analysis

on:
  schedule:
    # Run every Sunday at 9:00 AM UTC
    - cron: '0 9 * * 0'
  workflow_dispatch:  # Allow manual trigger

permissions:
  issues: write
  contents: write
  pull-requests: write

jobs:
  analyze:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install -r requirements.txt

      - name: Run email analysis
        env:
          # Easy Name Account (Primary)
          EMAIL_USER: ${{ secrets.EMAIL_USER }}
          EMAIL_PASS: ${{ secrets.EMAIL_PASS }}
          # Gmail Account
          GMAIL_USER: ${{ secrets.GMAIL_USER }}
          GMAIL_PASS: ${{ secrets.GMAIL_PASS }}
          # Wife's Easy Name Account (Optional)
          WIFE_EMAIL_USER: ${{ secrets.WIFE_EMAIL_USER }}
          WIFE_EMAIL_PASS: ${{ secrets.WIFE_EMAIL_PASS }}
        run: |
          python3 analyze_inbox.py > analysis_output.txt 2>&1 || true

      - name: Parse and format results
        id: parse
        run: |
          python3 .github/scripts/format_analysis.py analysis_output.txt > formatted_results.md

          # Check if there are unfiltered emails
          UNFILTERED_COUNT=$(grep -o "Ungefiltert:.*E-Mails" analysis_output.txt | grep -o "[0-9]*" | head -1 || echo "0")
          echo "unfiltered_count=$UNFILTERED_COUNT" >> $GITHUB_OUTPUT

          # Set issue title
          if [ "$UNFILTERED_COUNT" -eq "0" ]; then
            echo "issue_title=‚úÖ Weekly Email Analysis - All emails filtered!" >> $GITHUB_OUTPUT
          else
            echo "issue_title=üìß Weekly Email Analysis - $UNFILTERED_COUNT unfiltered emails" >> $GITHUB_OUTPUT
          fi

      - name: Apply rule suggestions automatically
        id: apply
        run: |
          echo "ü§ñ Automatically applying suggested rules..."
          python3 .github/scripts/apply_suggestions.py analysis_output.txt || true

          # Check if there are any changes
          if git diff --quiet; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "‚ÑπÔ∏è  No changes to commit (no new rules or all rules already exist)"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Changes detected - will create PR"
          fi

      - name: Create Pull Request with new rules
        if: steps.apply.outputs.has_changes == 'true'
        run: |
          # Configure git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Create branch with date
          BRANCH_NAME="weekly-analysis/$(date +%Y-%m-%d)"
          git checkout -b "$BRANCH_NAME"

          # Show what changed
          echo "üìù Changes to commit:"
          git diff --stat

          # Commit changes
          git add email_rules_*.json
          git commit -m "$(cat <<'EOF'
Add email rules from weekly analysis $(date +%Y-%m-%d)

Automatically generated from weekly email analysis.

- Applied suggested rules to appropriate config files
- Rules are ready for review and merge
EOF
)"

          # Push to remote
          echo "üöÄ Pushing branch: $BRANCH_NAME"
          git push -u origin "$BRANCH_NAME"

          # Store branch name for PR creation
          echo "BRANCH_NAME=$BRANCH_NAME" >> $GITHUB_ENV

      - name: Create Pull Request
        if: steps.apply.outputs.has_changes == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const branchName = process.env.BRANCH_NAME;
            const runDate = new Date().toISOString().split('T')[0];

            const prBody = `## ü§ñ Automated Weekly Email Analysis

This PR was automatically generated from the weekly email analysis on ${runDate}.

### üìä What's included:
- New email filtering rules based on analysis of unfiltered emails
- Rules have been automatically added to the appropriate config files

### ‚úÖ Next steps:
1. **Review the rules** below to ensure they look correct
2. **Merge this PR** to apply the new rules
3. The rules will take effect on the next email sorting run

### üìù Changed files:
See the file diffs below for the exact rules that were added.

---

**Generated by:** Weekly Email Analysis Workflow
**Analysis date:** ${runDate}`;

            try {
              const pr = await github.rest.pulls.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `üìß Add email rules from weekly analysis (${runDate})`,
                head: branchName,
                base: context.ref.replace('refs/heads/', ''),
                body: prBody,
                maintainer_can_modify: true
              });

              core.info(`‚úÖ Created PR #${pr.data.number}: ${pr.data.html_url}`);

              // Add label
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.data.number,
                labels: ['email-analysis', 'automated']
              });
            } catch (error) {
              if (error.message.includes('A pull request already exists')) {
                core.warning('‚ö†Ô∏è  A pull request already exists for this branch');
              } else {
                throw error;
              }
            }

      - name: Create or update issue
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const formattedResults = fs.readFileSync('formatted_results.md', 'utf8');
            const issueTitle = '${{ steps.parse.outputs.issue_title }}';
            const unfilteredCount = parseInt('${{ steps.parse.outputs.unfiltered_count }}');
            const hasChanges = '${{ steps.apply.outputs.has_changes }}' === 'true';

            // Search for existing open issue
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: ['email-analysis'],
              per_page: 1
            });

            const runDate = new Date().toISOString().split('T')[0];

            // Update how-to section based on automation status
            const howToSection = hasChanges
              ? `## ‚úÖ Automation Status

**ü§ñ Rules applied automatically!** A Pull Request has been created with the suggested rules.

üëâ **Review and merge the PR** to apply the new rules.

<details>
<summary>üìö Manual rule management (if needed)</summary>

### For legitimate senders:
1. Edit the appropriate email_rules_*.json file
2. Add rules manually to the "rules" array
3. Commit and push changes

### For spam:
1. Add the domain to spam_rules.json under "blacklist_domains"
2. Commit and push changes

</details>`
              : `## ‚ÑπÔ∏è No Changes Needed

All emails are already filtered or no new unique rules were suggested.`;

            const issueBody = '# Weekly Email Analysis Report\n\n' +
              'Run date: ' + runDate + '\n\n' +
              formattedResults + '\n\n' +
              '---\n\n' +
              howToSection + '\n\n' +
              '---\n\n' +
              '**Next analysis:** Next Sunday at 9:00 AM UTC\n' +
              '**Manual trigger:** Go to Actions ‚Üí Weekly Email Analysis ‚Üí Run workflow';

            // Always create or update an issue (for weekly status reports)
            if (issues.data.length > 0) {
              // Update existing issue
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issues.data[0].number,
                title: issueTitle,
                body: issueBody,
                labels: unfilteredCount > 0 ? ['email-analysis', 'needs-review'] : ['email-analysis'],
                state: 'open'
              });

              // Add a status comment
              const statusEmoji = unfilteredCount > 0 ? 'üìß' : '‚úÖ';
              const statusMsg = unfilteredCount > 0
                ? hasChanges
                  ? `Found ${unfilteredCount} unfiltered email(s). A Pull Request has been created automatically! ü§ñ`
                  : `Found ${unfilteredCount} unfiltered email(s). See updated report above.`
                : 'All emails are filtered! Inbox is clean. üéâ';

              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issues.data[0].number,
                body: `${statusEmoji} **Weekly Update:** ${runDate}\n\n${statusMsg}`
              });

              core.info(`Updated issue #${issues.data[0].number} - ${unfilteredCount} unfiltered email(s)`);
            } else {
              // Create new issue (always, even if inbox is clean)
              const labels = unfilteredCount > 0
                ? ['email-analysis', 'needs-review']
                : ['email-analysis'];

              const issue = await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: issueTitle,
                body: issueBody,
                labels: labels
              });

              core.info(`Created new issue #${issue.data.number} - ${unfilteredCount} unfiltered email(s)`);
            }
